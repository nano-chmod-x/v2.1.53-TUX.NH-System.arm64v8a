#!/bin/bash

# Title: Nmap Module Builder v2.1.0 (NetHunter Edition)
# Target: Kali NetHunter (Android Chroot)
# Description: Compiles Nmap with OpenSSL and Libpcap support.

set -e

# --- Configuration ---
VERSION="7.94" 
# In NetHunter, we typically install to /usr/local to avoid conflicts with system packages
PREFIX_DIR="/usr/local"
BUILD_DIR="$HOME/nmap_build_v2.1.0"
JOBS=$(nproc)

# --- Root Check ---
if [ "$EUID" -ne 0 ]; then
  echo "[!] Please run as root (NetHunter terminal usually defaults to root)."
  exit 1
fi

echo "[*] Initializing NetHunter Build Environment..."

# 1. Setup Dependencies
# Kali uses apt. We need the "-dev" versions of libraries to compile against them.
echo "[*] Updating repositories and installing build tools..."
apt-get update
apt-get install -y \
    build-essential \
    libssl-dev \
    libpcap-dev \
    libpcre2-dev \
    liblua5.4-dev \
    zlib1g-dev \
    curl \
    flex \
    bison \
    autoconf

# 2. Prepare Build Directory
mkdir -p "$BUILD_DIR"
cd "$BUILD_DIR"

# 3. Fetch Source
if [ ! -f "nmap-$VERSION.tar.bz2" ]; then
    echo "[*] Downloading Nmap v$VERSION..."
    curl -O "https://nmap.org/dist/nmap-$VERSION.tar.bz2"
fi

# Remove previous extraction if it exists to ensure a clean build
if [ -d "nmap-$VERSION" ]; then
    rm -rf "nmap-$VERSION"
fi

tar -xjf "nmap-$VERSION.tar.bz2"
cd "nmap-$VERSION"

# 4. Configure Build
# NetHunter is a standard Linux environment, so we don't need the strict prefix flags 
# that Termux needs. The compiler will find libs in /usr/include automatically.
echo "[*] Configuring source..."
./configure \
    --prefix="$PREFIX_DIR" \
    --without-zenmap \
    --without-ndiff \
    --without-nmap-update \
    --with-openssl \
    --with-libpcap \
    --with-libz

# Note: We let Nmap use its included Lua if system Lua causes version conflicts,
# but usually, standard configure finds the system headers fine.

# 5. Compile
echo "[*] Compiling with $JOBS cores..."
make -j"$JOBS"

# 6. Installation & Strip
echo "[*] Installing binaries..."
make install

# Strip symbols to reduce binary size
echo "[*] Optimizing binaries..."
strip "$PREFIX_DIR/bin/nmap"
strip "$PREFIX_DIR/bin/nping"

# 7. Refresh Hashmap
# Ensures the shell 'sees' the new binary immediately
hash -r

echo "--------------------------------------------------------"
echo "[+] Build v2.1.0 Complete."
echo "[+] Location: $PREFIX_DIR/bin/nmap"
echo "--------------------------------------------------------"
echo "Verify with: nmap --version"

###

#!/data/data/com.termux/files/usr/bin/bash

# Title: Nmap Module Builder v2.1.0
# Target: Termux (Android)
# Description: Compiles Nmap with OpenSSL and Libpcap support.

set -e

# --- Configuration ---
VERSION="7.94" # Current stable; adjust if specifically targeting a legacy v2.1.0
PREFIX_DIR=$PREFIX
BUILD_DIR="$HOME/nmap_build_v2.1.0"
JOBS=$(nproc)

echo "[*] Initializing Termux Build Environment..."

# 1. Setup Storage & Dependencies
termux-setup-storage
pkg update -y
pkg install -y \
    binutils \
    build-essential \
    clang \
    make \
    pkg-config \
    openssl \
    libpcap \
    libpcre2 \
    liblua54 \
    zlib \
    curl

# 2. Prepare Build Directory
mkdir -p "$BUILD_DIR"
cd "$BUILD_DIR"

# 3. Fetch Source
if [ ! -f "nmap-$VERSION.tar.bz2" ]; then
    echo "[*] Downloading Nmap v$VERSION..."
    curl -O "https://nmap.org/dist/nmap-$VERSION.tar.bz2"
fi

tar -xjf "nmap-$VERSION.tar.bz2"
cd "nmap-$VERSION"

# 4. Configure Build
# We use --with-libpcap=$PREFIX to ensure it links against Termux's patched pcap
# --without-zenmap is mandatory as GTK/Python GUI is not supported natively in shell
echo "[*] Configuring source for Termux prefix..."
./configure \
    --prefix="$PREFIX_DIR" \
    --with-openssl="$PREFIX_DIR" \
    --with-libpcap="$PREFIX_DIR" \
    --with-libpcre="$PREFIX_DIR" \
    --with-libz="$PREFIX_DIR" \
    --with-liblua="$PREFIX_DIR" \
    --without-zenmap \
    --without-ndiff \
    --without-nmap-update

# 5. Compile
echo "[*] Compiling with $JOBS cores..."
make -j"$JOBS"

# 6. Installation & Strip
echo "[*] Installing binaries..."
make install

# Strip symbols to reduce binary size (optimization for mobile)
echo "[*] Optimizing binaries..."
strip "$PREFIX_DIR/bin/nmap"
strip "$PREFIX_DIR/bin/nping"

echo "[+] Build v2.1.0 Complete. Verify with: nmap --version"